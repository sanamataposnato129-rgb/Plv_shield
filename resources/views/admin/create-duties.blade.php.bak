@extends('layouts.admin')

@section('title', 'Manage Duties')

@section('styles')
<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .duties-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 1.5rem;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .duties-table th {
        background: #1a1a4d;
        color: #fff;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .duties-table td {
        padding: 1rem;
        border-bottom: 1px solid #f1f1f1;
        color: #333;
    }

    .duties-table tr:hover {
        background: #f8f9fa;
    }

    .search-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-input, .filter-select {
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        flex: 1;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a1a4d;
        margin-bottom: 1rem;
    }

    .duties-form {
        background: #fff;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #1a1a4d;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #1a1a4d;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
    }

    .status-OPEN {
        background: #e3f2fd;
        color: #1565c0;
    }

    .status-IN_PROGRESS {
        background: #fff3e0;
        color: #ef6c00;
    }

    .status-COMPLETED {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .status-CANCELLED {
        background: #ffebee;
        color: #c62828;
    }

    .duties-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .alert {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 6px;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
@endsection

@section('content')
<div class="container">
    @if(session('success'))
    <div class="alert alert-success">
        {{ session('success') }}
    </div>
    @endif

    @if(session('error'))
    <div class="alert alert-danger">
        {{ session('error') }}
    </div>
    @endif

    <div class="duties-header">
        <h1>Manage Event Duties</h1>
        <div class="duties-actions">
            <button class="btn btn-primary" onclick="showCreateForm()">
                <i class="fas fa-plus"></i>
                Create New Duty
            </button>
            <button class="btn btn-secondary" onclick="refreshTable()">
                <i class="fas fa-sync"></i>
                Refresh
            </button>
        </div>
    </div>

    <div class="search-filters">
        <input type="text" class="search-input" placeholder="Search duties...">
        <select class="filter-select">
            <option value="">All Statuses</option>
            <option value="OPEN">Open</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="UNDER_REVIEW">Under Review</option>
            <option value="CERTIFIED">Certified</option>
            <option value="COMPLETED">Completed</option>
            <option value="CANCELLED">Cancelled</option>
        </select>
        <input type="date" class="filter-select">
    </div>

    <div class="duties-form" id="createDutyForm" style="display: none;">
        <h2 class="page-title">Create New Duty</h2>
        <form action="{{ route('admin.duties.store') }}" method="POST">
            @csrf
            <div class="form-group">
                <label class="form-label" for="title">Title</label>
                <input class="form-control" type="text" id="title" name="title" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="description">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" for="duty_date">Date</label>
                <input class="form-control" type="date" id="duty_date" name="duty_date" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="start_time">Start Time</label>
                <input class="form-control" type="time" id="start_time" name="start_time" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="end_time">End Time</label>
                <input class="form-control" type="time" id="end_time" name="end_time" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="number_of_participants">Number of Participants</label>
                <input class="form-control" type="number" id="number_of_participants" name="number_of_participants" min="0" required>
            </div>

            <div class="duties-actions">
                <button type="submit" class="btn btn-primary">Create Duty</button>
                <button type="button" class="btn btn-secondary" onclick="hideCreateForm()">Cancel</button>
            </div>
        </form>
    </div>

    <div class="duties-table">
        <table>
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Participants</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @forelse($duties as $duty)
                <tr>
                    <td>{{ $duty->title }}</td>
                    <td>{{ $duty->duty_date->format('M d, Y') }}</td>
                    <td>{{ $duty->start_time }} - {{ $duty->end_time }}</td>
                    <td>{{ $duty->number_of_participants }}</td>
                    <td><span class="status-badge status-{{ $duty->status }}">{{ str_replace('_', ' ', $duty->status) }}</span></td>
                    <td class="duties-actions">
                        <a href="{{ route('admin.duties.edit', $duty->event_id) }}" class="btn btn-primary">Edit</a>
                        <form action="{{ route('admin.duties.destroy', $duty->event_id) }}" method="POST" style="display: inline;">
                            @csrf
                            @method('DELETE')
                            <button type="submit" class="btn btn-secondary" onclick="return confirm('Are you sure you want to delete this duty?')">Delete</button>
                        </form>
                    </td>
                </tr>
                @empty
                <tr>
                    <td colspan="6" class="text-center">No duties found</td>
                </tr>
                @endforelse
            </tbody>
        </table>
    </div>

    .duty-details.active {
        display: block;
    }

    .duty-details h3 {
        margin: 0 0 1.5rem 0;
        color: #1a1a4d;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .detail-row {
        margin: 1rem 0;
        display: flex;
        gap: 1.5rem;
        align-items: flex-start;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail-label {
        font-weight: 600;
        min-width: 150px;
        color: #1a1a4d;
    }

    .detail-value {
        color: #555;
        flex: 1;
        line-height: 1.5;
    }

    /* Status Badge Styles */
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-badge::before {
        content: '';
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-OPEN {
        background: #e3f2fd;
        color: #1565c0;
    }
    .status-OPEN::before {
        background: #1565c0;
    }

    .status-IN_PROGRESS {
        background: #fff3e0;
        color: #ef6c00;
    }
    .status-IN_PROGRESS::before {
        background: #ef6c00;
    }

    .status-UNDER_REVIEW {
        background: #e8f5e9;
        color: #2e7d32;
    }
    .status-UNDER_REVIEW::before {
        background: #2e7d32;
    }

    .status-CERTIFIED { 
        background: #f3e5f5; 
        color: #7b1fa2; 
    }
    .status-COMPLETED { 
        background: #e8eaf6; 
        color: #3f51b5; 
    }
    .status-CANCELLED { 
        background: #ffebee; 
        color: #c62828; 
    }
    .btn {
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9em;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
    }
    .btn:hover {
        transform: translateY(-1px);
    }
    .btn-sm {
        padding: 6px 10px;
        font-size: 0.85em;
    }
    .btn-primary {
        background: #1a1a4d;
        color: white;
    }
    .btn-success {
        background: #2e7d32;
        color: white;
    }
    .btn-info {
        background: #1565c0;
        color: white;
    }
    .btn-warning {
        background: #ef6c00;
        color: white;
    }
    .btn-danger {
        background: #c62828;
        color: white;
    }
    .form-control {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 0.9em;
    }
    .form-control:focus {
        outline: none;
        border-color: #1a1a4d;
        box-shadow: 0 0 0 2px rgba(26,26,77,0.1);
    }
    .alert {
        padding: 12px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }
    .alert-success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #a5d6a7;
    }
    .text-center {
        text-align: center;
    }
</style>
@endsection

@section('content')
    <div class="duties-header">
        <h2>Event Duties</h2>
        <div class="duties-actions">
            <a href="{{ route('admin.create-duties') }}" class="btn btn-primary">Refresh</a>
            <button id="toggleCreate" class="btn btn-success">Create Duty</button>
        </div>
    </div>

    @if(session('success'))
        <div class="alert alert-success">{{ session('success') }}</div>
    @endif

    <div class="search-filter" style="margin-top:12px;display:flex;gap:12px;align-items:center;">
        <form method="GET" action="{{ route('admin.create-duties') }}" style="display:flex;gap:8px;align-items:center;">
            <input type="text" name="search" placeholder="Search title/description/id" value="{{ $search ?? '' }}" class="form-control">
            <select name="status" class="form-control">
                <option value="">All statuses</option>
                <option value="OPEN" {{ (isset($status) && $status=='OPEN')? 'selected': '' }}>OPEN</option>
                <option value="IN_PROGRESS" {{ (isset($status) && $status=='IN_PROGRESS')? 'selected': '' }}>IN_PROGRESS</option>
                <option value="UNDER_REVIEW" {{ (isset($status) && $status=='UNDER_REVIEW')? 'selected': '' }}>UNDER_REVIEW</option>
                <option value="CERTIFIED" {{ (isset($status) && $status=='CERTIFIED')? 'selected': '' }}>CERTIFIED</option>
                <option value="COMPLETED" {{ (isset($status) && $status=='COMPLETED')? 'selected': '' }}>COMPLETED</option>
                <option value="CANCELLED" {{ (isset($status) && $status=='CANCELLED')? 'selected': '' }}>CANCELLED</option>
            </select>
            <button class="btn btn-secondary">Filter</button>
        </form>
    </div>

    <div id="createForm" class="duties-form" style="display:none;">
        <form method="POST" action="{{ route('admin.duties.store') }}">
            @csrf
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <input name="title" placeholder="Title" class="form-control" required>
                <input name="duty_date" type="date" class="form-control" required>
                <input name="start_time" type="time" class="form-control" required>
                <input name="end_time" type="time" class="form-control" required>
                <input name="number_of_participants" type="number" min="0" class="form-control" placeholder="Number of participants">
                <select name="status" class="form-control">
                    <option value="OPEN">OPEN</option>
                    <option value="IN_PROGRESS">IN_PROGRESS</option>
                    <option value="UNDER_REVIEW">UNDER_REVIEW</option>
                    <option value="CERTIFIED">CERTIFIED</option>
                    <option value="COMPLETED">COMPLETED</option>
                    <option value="CANCELLED">CANCELLED</option>
                </select>
            </div>
            <div style="margin-top:8px;">
                <textarea name="description" class="form-control" placeholder="Description" required></textarea>
            </div>
            <div style="margin-top:8px;text-align:right;">
                <button class="btn btn-primary">Create Duty</button>
            </div>
        </form>
    </div>

    <table class="duties-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Date</th>
                <th>Time</th>
                <th>Participants</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @forelse($duties as $duty)
                <tr class="duty-row" data-duty="{{ json_encode($duty) }}">
                    <td>{{ $duty->event_id }}</td>
                    <td>{{ $duty->title }}</td>
                    <td>{{ optional($duty->duty_date)->format('M d, Y') }}</td>
                    <td>{{ $duty->start_time }} - {{ $duty->end_time }}</td>
                    <td>{{ $duty->number_of_participants }}</td>
                    <td><span class="status-badge status-{{ $duty->status }}">{{ $duty->status }}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info view-duty">View</button>
                        <a href="{{ route('admin.duties.edit', $duty->event_id) }}" class="btn btn-sm btn-warning">Edit</a>
                        <form method="POST" action="{{ route('admin.duties.destroy', $duty->event_id) }}" style="display:inline-block;margin-left:6px;">
                            @csrf
                            @method('DELETE')
                            <button class="btn btn-sm btn-danger" onclick="return confirm('Delete this duty?')">Delete</button>
                        </form>
                    </td>
                </tr>
            @empty
                <tr><td colspan="7">No duties found.</td></tr>
            @endforelse
        </tbody>
    </table>

    <div style="margin-top:12px;">{{ $duties->links() }}</div>

    <!-- Duty Details Section -->
    <div id="dutyDetails" class="duty-details">
        <h3>Duty Details</h3>
        <div class="detail-row">
            <span class="detail-label">ID:</span>
            <span class="detail-value" id="detail-id"></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Title:</span>
            <span class="detail-value" id="detail-title"></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Date:</span>
            <span class="detail-value" id="detail-date"></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Time:</span>
            <span class="detail-value" id="detail-time"></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Participants:</span>
            <span class="detail-value" id="detail-participants"></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value" id="detail-status"></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Description:</span>
            <span class="detail-value" id="detail-description"></span>
        </div>
    </div>
@endsection

@section('scripts')
<script>
document.getElementById('toggleCreate').addEventListener('click', function() {
    const el = document.getElementById('createForm');
    el.style.display = (el.style.display === 'none') ? 'block' : 'none';
});

// Handle duty details view
document.querySelectorAll('.view-duty').forEach(button => {
    button.addEventListener('click', function() {
        const row = this.closest('tr');
        const duty = JSON.parse(row.dataset.duty);
        const details = document.getElementById('dutyDetails');
        
        // Update details
        document.getElementById('detail-id').textContent = duty.event_id;
        document.getElementById('detail-title').textContent = duty.title;
        document.getElementById('detail-date').textContent = new Date(duty.duty_date).toLocaleDateString();
        document.getElementById('detail-time').textContent = `${duty.start_time} - ${duty.end_time}`;
        document.getElementById('detail-participants').textContent = duty.number_of_participants;
        document.getElementById('detail-status').textContent = duty.status;
        document.getElementById('detail-description').textContent = duty.description;

        // Show details section
        details.classList.add('active');
        
        // Scroll to details
        details.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
});
</script>
@endsection

@section('content')
    <div class="duties-header">
        <h2>Event Duties</h2>
        <div class="duties-actions">
            <a href="{{ route('admin.create-duties') }}" class="btn btn-primary">Refresh</a>
            <button id="toggleCreate" class="btn btn-success">Create Duty</button>
        </div>
    </div>

    @if(session('success'))
        <div class="alert alert-success">{{ session('success') }}</div>
    @endif

    <div class="search-filter" style="margin-top:12px;display:flex;gap:12px;align-items:center;">
        <form method="GET" action="{{ route('admin.create-duties') }}" style="display:flex;gap:8px;align-items:center;">
            <input type="text" name="search" placeholder="Search title/description/id" value="{{ $search ?? '' }}" class="form-control">
            <select name="status" class="form-control">
                <option value="">All statuses</option>
                <option value="OPEN" {{ (isset($status) && $status=='OPEN')? 'selected': '' }}>OPEN</option>
                <option value="IN_PROGRESS" {{ (isset($status) && $status=='IN_PROGRESS')? 'selected': '' }}>IN_PROGRESS</option>
                <option value="UNDER_REVIEW" {{ (isset($status) && $status=='UNDER_REVIEW')? 'selected': '' }}>UNDER_REVIEW</option>
                <option value="CERTIFIED" {{ (isset($status) && $status=='CERTIFIED')? 'selected': '' }}>CERTIFIED</option>
                <option value="COMPLETED" {{ (isset($status) && $status=='COMPLETED')? 'selected': '' }}>COMPLETED</option>
                <option value="CANCELLED" {{ (isset($status) && $status=='CANCELLED')? 'selected': '' }}>CANCELLED</option>
            </select>
            <button class="btn btn-secondary">Filter</button>
        </form>
    </div>

    <div id="createForm" class="duties-form" style="display:none;">
        <form method="POST" action="{{ route('admin.duties.store') }}">
            @csrf
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <input name="title" placeholder="Title" class="form-control" required>
                <input name="duty_date" type="date" class="form-control" required>
                <input name="start_time" type="time" class="form-control" required>
                <input name="end_time" type="time" class="form-control" required>
                <input name="number_of_participants" type="number" min="0" class="form-control" placeholder="Number of participants">
                <select name="status" class="form-control">
                    <option value="OPEN">OPEN</option>
                    <option value="IN_PROGRESS">IN_PROGRESS</option>
                    <option value="UNDER_REVIEW">UNDER_REVIEW</option>
                    <option value="CERTIFIED">CERTIFIED</option>
                    <option value="COMPLETED">COMPLETED</option>
                    <option value="CANCELLED">CANCELLED</option>
                </select>
            </div>
            <div style="margin-top:8px;">
                <textarea name="description" class="form-control" placeholder="Description" required></textarea>
            </div>
            <div style="margin-top:8px;text-align:right;">
                <button class="btn btn-primary">Create Duty</button>
            </div>
        </form>
    </div>

    <table class="duties-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Date</th>
                <th>Time</th>
                <th>Participants</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @forelse($duties as $duty)
                <tr class="duty-row" data-duty="{{ json_encode($duty) }}">
                    <td>{{ $duty->event_id }}</td>
                    <td>{{ $duty->title }}</td>
                    <td>{{ optional($duty->duty_date)->format('M d, Y') }}</td>
                    <td>{{ $duty->start_time }} - {{ $duty->end_time }}</td>
                    <td>{{ $duty->number_of_participants }}</td>
                    <td><span class="status-badge status-{{ $duty->status }}">{{ $duty->status }}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info view-duty">View</button>
                        <a href="{{ route('admin.duties.edit', $duty->event_id) }}" class="btn btn-sm btn-warning">Edit</a>
                        <form method="POST" action="{{ route('admin.duties.destroy', $duty->event_id) }}" style="display:inline-block;margin-left:6px;">
                            @csrf
                            @method('DELETE')
                            <button class="btn btn-sm btn-danger" onclick="return confirm('Delete this duty?')">Delete</button>
                        </form>
                    </td>
                </tr>
            @empty
                <tr><td colspan="7" class="text-center">No duties found.</td></tr>
            @endforelse
        </tbody>
    </table>

    <div style="margin-top:12px;">{{ $duties->links() }}</div>

@endsection

@section('scripts')
<script>
document.getElementById('toggleCreate').addEventListener('click', function() {
    const el = document.getElementById('createForm');
    el.style.display = (el.style.display === 'none') ? 'block' : 'none';
});

// Handle duty details view
document.querySelectorAll('.view-duty').forEach(button => {
    button.addEventListener('click', function() {
        const row = this.closest('tr');
        const duty = JSON.parse(row.dataset.duty);
        const details = document.getElementById('dutyDetails');
        
        // Update details
        document.getElementById('detail-id').textContent = duty.event_id;
        document.getElementById('detail-title').textContent = duty.title;
        document.getElementById('detail-date').textContent = new Date(duty.duty_date).toLocaleDateString();
        document.getElementById('detail-time').textContent = `${duty.start_time} - ${duty.end_time}`;
        document.getElementById('detail-participants').textContent = duty.number_of_participants;
        document.getElementById('detail-status').textContent = duty.status;
        document.getElementById('detail-description').textContent = duty.description;

        // Show details section
        details.classList.add('active');
        
        // Scroll to details
        details.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
});
</script>
@endsection
